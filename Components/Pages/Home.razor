@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using TodoApp.Data
@using TodoApp.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Web
@inject AppDbContext Db
@inject IJSRuntime JS

<PageTitle>Todo App</PageTitle>

<h1>Todo List</h1>

<EditForm Model="@newTodo" OnValidSubmit="@AddTodo" formname="AddTodoForm">
    <DataAnnotationsValidator /> <!-- Optional: Adds basic validation if you add [Required] to Title later -->
    <ValidationSummary /> <!-- Optional: Shows errors if validation fails -->
    <InputText @bind-Value="newTodo.Title" placeholder="New todo title" class="form-control mb-2" />
    <button type="submit" class="btn btn-primary">Add</button>
</EditForm>

@if (todos.Any())
{
    <ul>
    @foreach (var todo in todos)
        {
            <li>
                <InputCheckbox @bind-Value="todo.IsCompleted" />
                <span class="@(todo.IsCompleted ? "completed" : "")">@todo.Title</span>
                <button @onclick="() => DeleteTodo(todo.Id)">Delete</button>
            </li>
        }
    </ul>
}
else
{
    <p>No todos yet—add one above!</p>
}

@code {
    private List<TodoItem> todos = new();
    private TodoItem newTodo = new() { IsCompleted = false }; // Initialize fully

    protected override async Task OnInitializedAsync()
    {
        todos = await Db.TodoItems.ToListAsync();
    }

    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(newTodo.Title))
        {
            try
            {
                Db.TodoItems.Add(newTodo);
                await Db.SaveChangesAsync();
                todos = await Db.TodoItems.ToListAsync();
                newTodo = new() { IsCompleted = false };
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in AddTodo: {ex.Message}"); // ← Add: Catch silent fails
            }
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Title cannot be empty!");
        }
    }

    private async Task DeleteTodo(int id)
    {
        var todo = await Db.TodoItems.FindAsync(id);
        if (todo != null)
        {
            Db.TodoItems.Remove(todo);
            await Db.SaveChangesAsync();
            todos = await Db.TodoItems.ToListAsync();
            StateHasChanged();
        }
    }
}