@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using TodoApp.Data
@using TodoApp.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Web
@inject AppDbContext Db
@inject IJSRuntime JS

<PageTitle>Todo App</PageTitle>

<h1>Todo List</h1>

<EditForm Model="@currentTodo" OnValidSubmit="@HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <InputText @bind-Value="currentTodo.Title" placeholder="Todo title" class="form-control mb-2" />
    <button type="submit" class="btn btn-primary">
        @(editing ? "Update" : "Add")
    </button>
    @if (editing)
    {
        <button type="button" @onclick="CancelEdit" class="btn btn-secondary ms-2">Cancel</button>
    }
</EditForm>

@if (todos.Any())
{
    <ul class="mt-3">
    @foreach (var todo in todos)
        {
            <li class="d-flex align-items-center justify-content-between p-2 border mb-2 w-100">  <!-- Add justify-content-between and w-100 -->
                <div class="d-flex align-items-center gap-2 flex-grow-1">  <!-- Wrap checkbox/label in flex-grow div -->
                    <InputCheckbox @bind-Value="todo.IsCompleted" />
                    <label @onclick="() => ToggleTodo(todo)" class="form-check-label cursor-pointer mb-0">
                        <span class="@(todo.IsCompleted ? "completed" : "")">@todo.Title</span>
                    </label>
                </div>
                <div class="d-flex gap-2">  <!-- Buttons right-aligned -->
                    <button type="button" @onclick="() => StartEdit(todo)" class="btn btn-sm btn-outline-primary">Edit</button>
                    <button type="button" @onclick="() => DeleteTodo(todo.Id)" class="btn btn-sm btn-outline-danger">Delete</button>
                </div>
            </li>
        }
    </ul>
}
else
{
    <p class="mt-3">No todos yet—add one above!</p>
}

@code {
    internal List<TodoItem> todos = new();
    private TodoItem currentTodo = new() { IsCompleted = false };
    private bool editing = false;
    private int? editingId = null;

    protected override async Task OnInitializedAsync()
    {
        todos = await Db.TodoItems.ToListAsync();
        Console.WriteLine($"Loaded {todos.Count} todos");
    }

    private async Task HandleSubmit()
    {
        if (!string.IsNullOrWhiteSpace(currentTodo.Title))
        {
            try
            {
                if (editing)
                {
                    // Update existing
                    var existing = await Db.TodoItems.FindAsync(editingId);
                    if (existing != null)
                    {
                        existing.Title = currentTodo.Title;
                        existing.IsCompleted = currentTodo.IsCompleted;
                        await Db.SaveChangesAsync();
                    }
                }
                else
                {
                    // Add new
                    Db.TodoItems.Add(currentTodo);
                    await Db.SaveChangesAsync();
                }

                await RefreshTodos();
                ResetForm();
            }
            catch (Exception ex)
            {
                // Log or handle error (e.g., await JS.InvokeVoidAsync("console.log", $"Error: {ex.Message}"); )
            }
        }
    }

    private void StartEdit(TodoItem todo)
    {
        currentTodo = new TodoItem
        {
            Id = todo.Id,
            Title = todo.Title,
            IsCompleted = todo.IsCompleted
        };
        editing = true;
        editingId = todo.Id;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        ResetForm();
    }

    private void ResetForm()
    {
        currentTodo = new() { IsCompleted = false };
        editing = false;
        editingId = null;
        StateHasChanged();
    }

    private async Task RefreshTodos()
    {
        todos = await Db.TodoItems.ToListAsync();
    }

    private async Task DeleteTodo(int id)
    {
        var todo = await Db.TodoItems.FindAsync(id);
        if (todo != null)
        {
            Db.TodoItems.Remove(todo);
            await Db.SaveChangesAsync();
            await RefreshTodos();
        }
    }

    private async Task ToggleTodo(TodoItem todo)
    {
        todo.IsCompleted = !todo.IsCompleted;

        Db.Entry(todo).State = EntityState.Modified;
        await Db.SaveChangesAsync();

        StateHasChanged(); // UI update (strikethrough)
    }

}